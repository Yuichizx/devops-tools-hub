<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>JSON â†’ SQL DDL</title>
  
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/favicon.png') }}">
  <script src="{{ url_for('static', filename='js/tailwind-latest.js') }}" crossorigin="anonymous"></script>
  <link href="{{ url_for('static', filename='css/bootstrap-icons.min.css') }}" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
  <script src="{{ url_for('static', filename='js/theme.js') }}"></script>

  <style>
    body { background-color: var(--bg); color: var(--text); transition: .3s; }
    .main-card { background-color: var(--panel); border: 1px solid var(--border); color: var(--text); }
    textarea, input { background-color: var(--bg) !important; border-color: var(--border) !important; color: var(--text) !important; }
    textarea:focus, input:focus { border-color: var(--btn-primary) !important; outline: none; box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.2); }
    .btn-tool { background-color: var(--bg); border: 1px solid var(--border); color: var(--muted); }
    .btn-tool:hover { background-color: var(--btn-hover); color: var(--text); }
    #toast { transition: transform .3s, opacity .3s; z-index: 99; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-8 font-sans">
  
  <div class="container mx-auto max-w-6xl">
    <header class="flex flex-col md:flex-row items-center justify-between mb-8 gap-4">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold flex items-center gap-2">
            <i class="bi bi-database text-indigo-500"></i> JSON â†’ SQL DDL
        </h1>
        <p class="mt-1 opacity-70">Generate script `CREATE TABLE` dari sampel data JSON.</p>
      </div>
            <div class="flex gap-2">
                <button id="btnTheme" class="btn-action px-4 py-2 rounded-lg text-sm font-medium shadow-sm">ðŸŒž Light</button>
                <a href="{{ url_for('routes.json_formatter_index') }}"
                   class="btn-action px-4 py-2 rounded-lg text-sm font-medium shadow-sm flex items-center gap-2">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
    </header>

    <div class="main-card rounded-xl shadow-lg p-6 md:p-8">
      
      <!-- Input Table Name -->
      <div class="mb-6">
          <label class="block font-bold opacity-90 mb-2">Nama Tabel</label>
          <input type="text" id="tableName" value="users" class="w-full md:w-1/3 p-3 border rounded-lg" placeholder="Contoh: users_table">
      </div>

      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <label class="font-bold opacity-90">Input JSON</label>
          <button id="btnPaste" class="btn-tool px-3 py-1 rounded text-sm flex items-center gap-2"><i class="bi bi-clipboard"></i> Paste</button>
        </div>
        <textarea id="inputJson" placeholder='[
  {"id": 1, "name": "Alice", "email": "alice@example.com", "active": true},
  {"id": 2, "name": "Bob", "email": "bob@example.com", "active": false}
]' class="w-full p-4 border rounded-lg min-h-[200px] font-mono text-sm"></textarea>
      </div>

      <div class="flex flex-col md:flex-row items-center justify-center gap-3 mb-6">
        <button id="btnConvert" class="w-full md:w-auto bg-indigo-600 text-white px-8 py-3 text-base font-semibold rounded-lg hover:bg-indigo-700 shadow-md inline-flex items-center gap-2 justify-center transition transform active:scale-95">
          <i class="bi bi-magic"></i> Generate SQL
        </button>
        <button id="btnReset" class="w-full md:w-auto btn-tool px-6 py-3 text-base font-semibold rounded-lg shadow-sm inline-flex items-center gap-2 justify-center">
          <i class="bi bi-arrow-counterclockwise"></i> Reset
        </button>
      </div>

      <div>
        <div class="flex justify-between items-center mb-2">
          <label class="font-bold opacity-90">Hasil SQL Query</label>
          <div class="flex gap-2">
            <button id="btnCopy" class="btn-tool px-3 py-1 rounded text-sm flex items-center gap-2"><i class="bi bi-copy"></i> Salin</button>
          </div>
        </div>
        <textarea id="outputCode" readonly class="w-full p-4 border rounded-lg min-h-[300px] font-mono text-sm whitespace-pre"></textarea>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-5 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0">
    <p id="toast-message">Pesan notifikasi.</p>
  </div>

  <script>
    const toast = document.getElementById('toast'), toastMsg = document.getElementById('toast-message'); 
    let t;
    function showToast(m, type='success'){
        clearTimeout(t); 
        toastMsg.textContent=m;
        toast.className = 'fixed bottom-5 right-5 text-white px-5 py-3 rounded-lg shadow-xl transform translate-y-0 opacity-100 ' + (type==='error'?'bg-red-600':'bg-slate-800'); 
        t = setTimeout(() => toast.className = 'fixed bottom-5 right-5 text-white px-5 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0', 3000); 
    }

    const inputJson = document.getElementById('inputJson');
    const outputCode = document.getElementById('outputCode');
    const tableNameInput = document.getElementById('tableName');

    document.getElementById('btnPaste').onclick = async () => {
      try { const x = await navigator.clipboard.readText(); if (x) { inputJson.value = x; showToast('Teks ditempel!'); } } catch { showToast('Gagal paste','error'); }
    };
    document.getElementById('btnReset').onclick = () => { inputJson.value=''; outputCode.value=''; showToast('Direset.'); };
    document.getElementById('btnCopy').onclick = () => { if(!outputCode.value) return showToast('Kosong','error'); navigator.clipboard.writeText(outputCode.value).then(()=>showToast('Disalin!')); };

    // --- LOGIC KONVERSI JSON KE SQL ---
    function guessType(val) {
        if (val === null) return "VARCHAR(255)"; // Fallback
        const t = typeof val;
        if (t === 'number') {
            return Number.isInteger(val) ? "INT" : "DECIMAL(10, 2)";
        }
        if (t === 'boolean') return "BOOLEAN";
        if (t === 'string') {
            // Cek apakah tanggal
            if (/^\d{4}-\d{2}-\d{2}( [0-9:.]*)?$/.test(val)) return "DATETIME";
            return val.length > 255 ? "TEXT" : "VARCHAR(255)";
        }
        return "TEXT"; // Object/Array disimpan sebagai TEXT/JSON
    }

    document.getElementById('btnConvert').onclick = () => {
        const raw = inputJson.value.trim();
        if (!raw) return showToast('Input JSON kosong', 'error');

        let data;
        try {
            data = JSON.parse(raw);
        } catch (e) {
            return showToast('JSON tidak valid', 'error');
        }

        // Normalisasi: jika object tunggal, jadikan array
        if (!Array.isArray(data)) {
            data = [data];
        }

        if (data.length === 0) return showToast('JSON Array kosong', 'error');

        // Analisis kolom dari elemen pertama (dan gabungkan jika perlu)
        const columns = {};
        
        // Sampling hingga 10 baris pertama untuk menebak tipe data terbaik
        const sampleLimit = Math.min(data.length, 10);
        
        for(let i=0; i<sampleLimit; i++) {
            const row = data[i];
            for (const key in row) {
                if (!columns[key]) {
                    columns[key] = guessType(row[key]);
                } else {
                    // Upgrade tipe jika perlu (misal INT -> TEXT jika ada string campuran)
                    const currentType = columns[key];
                    const newType = guessType(row[key]);
                    if (currentType === "INT" && newType === "DECIMAL(10, 2)") columns[key] = "DECIMAL(10, 2)";
                    if (currentType !== "TEXT" && newType === "TEXT") columns[key] = "TEXT";
                }
            }
        }

        const tableName = tableNameInput.value.trim() || "my_table";
        let sql = `CREATE TABLE ${tableName} (\n`;
        const colDefs = [];
        
        // Prioritaskan 'id' di atas
        const keys = Object.keys(columns).sort((a,b) => {
            if(a === 'id') return -1;
            if(b === 'id') return 1;
            return a.localeCompare(b);
        });

        keys.forEach(key => {
            let def = `    ${key} ${columns[key]}`;
            if (key === 'id' && columns[key] === 'INT') {
                def += " PRIMARY KEY";
            }
            colDefs.push(def);
        });

        sql += colDefs.join(",\n");
        sql += "\n);

";

        // Generate INSERT statements (opsional, max 20 baris agar tidak memenuhkan layar)
        if (data.length > 0) {
            sql += "-- Contoh Data (" + Math.min(data.length, 20) + " baris)\n";
            sql += `INSERT INTO ${tableName} (${keys.join(', ')}) VALUES\n`;
            
            const inserts = [];
            data.slice(0, 20).forEach(row => {
                const values = keys.map(k => {
                    const val = row[k];
                    if (val === null) return "NULL";
                    if (typeof val === 'number') return val;
                    if (typeof val === 'boolean') return val ? 'TRUE' : 'FALSE';
                    // Escape single quotes for SQL
                    const strVal = String(val).replace(/'/g, "''");
                    return `'${strVal}'`;
                });
                inserts.push(`    (${values.join(', ')})`);
            });
            sql += inserts.join(",\n") + ";";
        }

        outputCode.value = sql;
        showToast('SQL berhasil digenerate!');
    };
  </script>
</body>
</html>