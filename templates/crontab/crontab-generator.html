{% extends "layout.html" %}

{% block content %}
<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h2">Crontab Generator</h1>
      <a href="{{ url_for('routes.landing') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i> Back
      </a>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-body p-4">
            <div class="row g-4">
                <div class="col-lg-7">
                    <h5 class="mb-3">Ekspresi & Perintah</h5>
                    
                    <div class="mb-3">
                        <label for="cronExpressionInput" class="form-label">Ekspresi Waktu (5 bagian)</label>
                        <input type="text" class="form-control font-monospace" id="cronExpressionInput" value="* * * * *">
                    </div>
                    
                    <div class="mb-3">
                        <label for="commandInput" class="form-label">Perintah yang akan dijalankan</label>
                        <input type="text" class="form-control font-monospace" id="commandInput" placeholder="/path/to/your/command">
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-secondary btn-sm" id="randomBtn"><i class="bi bi-shuffle me-1"></i> Buat Jadwal Acak</button>
                    </div>
                </div>
                
                <div class="col-lg-5">
                    <h5 class="mb-3">Hasil</h5>
                    <div class="mb-3">
                        <label for="cronOutput" class="form-label">Ekspresi Cron Lengkap</label>
                        <div class="input-group">
                            <input type="text" readonly class="form-control font-monospace" id="cronOutput">
                            <button class="btn btn-outline-secondary" type="button" id="copyBtn" title="Copy Expression"><i class="bi bi-clipboard"></i></button>
                        </div>
                    </div>
                    
                    <div id="resultsWrapper" class="p-3 bg-light rounded border" style="min-height: 150px;">
                        <p id="cronExplanation" class="fw-bold mb-2"></p>
                        <div id="nextRuns" class="small font-monospace"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card shadow-sm">
        <div class="card-body p-4">
            <h5 class="mb-3">Crontab Cheat Sheet</h5>
            <pre class="bg-light p-3 rounded font-monospace small mb-0">┌───────────── menit (0 - 59)
│ ┌─────────── jam (0 - 23)
│ │ ┌───────── tgl. bulan (1 - 31)
│ │ │ ┌─────── bulan (1 - 12)
│ │ │ │ ┌───── hari minggu (0 - 6) (0=Minggu)
* * * * * perintah_untuk_dijalankan</pre>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const expressionInputEl = document.getElementById("cronExpressionInput");
        const commandInputEl = document.getElementById("commandInput");
        
        const cronOutputEl = document.getElementById("cronOutput");
        const cronExplanationEl = document.getElementById("cronExplanation");
        const nextRunsEl = document.getElementById("nextRuns");
        const resultsWrapper = document.getElementById("resultsWrapper");
        const copyBtn = document.getElementById("copyBtn");
        const randomBtn = document.getElementById("randomBtn");

        // --- LOGIKA PARSER ---
        function parseCron(expression) {
            const parts = expression.trim().split(/\s+/);
            if (parts.length !== 5) throw new Error("Format waktu harus memiliki 5 bagian.");
            const [minute, hour, dayOfMonth, month, dayOfWeek] = parts;
            const isValid = (part, min, max) => part === '*' || (!isNaN(part) && parseInt(part) >= min && parseInt(part) <= max);
            if (!isValid(minute, 0, 59) || !isValid(hour, 0, 23) || !isValid(dayOfMonth, 1, 31) || !isValid(month, 1, 12) || !isValid(dayOfWeek, 0, 6)) {
                throw new Error("Nilai waktu tidak valid. Gunakan '*' atau angka dalam rentang yang benar.");
            }
            return { minute, hour, dayOfMonth, month, dayOfWeek };
        }

        function generateExplanation(parts) {
            if (Object.values(parts).every(p => p === '*')) return "Setiap menit.";
            let timeDesc = '';
            if (parts.minute === '0' && parts.hour !== '*') timeDesc = `Pada awal jam ${parts.hour}.`;
            else if (parts.minute !== '*' && parts.hour !== '*') timeDesc = `Pada pukul ${parts.hour.padStart(2, '0')}:${parts.minute.padStart(2, '0')}.`;
            else if (parts.minute !== '*') timeDesc = `Pada menit ke-${parts.minute}.`;
            else if (parts.hour !== '*') timeDesc = `Setiap menit pada jam ${parts.hour}.`;
            else timeDesc = "Setiap menit.";
            return timeDesc;
        }

        function calculateNextRuns(parts, count = 5) {
            const runs = [];
            let currentDate = new Date();
            currentDate.setSeconds(0); currentDate.setMilliseconds(0);
            for (let i = 0; i < (60 * 24 * 366) && runs.length < count; i++) {
                currentDate.setMinutes(currentDate.getMinutes() + 1);
                const m = currentDate.getMinutes(), h = currentDate.getHours(), dom = currentDate.getDate(), mo = currentDate.getMonth() + 1, dow = currentDate.getDay();
                const minuteMatch = parts.minute === '*' || parseInt(parts.minute) === m;
                const hourMatch = parts.hour === '*' || parseInt(parts.hour) === h;
                const dayOfMonthMatch = parts.dayOfMonth === '*' || parseInt(parts.dayOfMonth) === dom;
                const monthMatch = parts.month === '*' || parseInt(parts.month) === mo;
                const dayOfWeekMatch = parts.dayOfWeek === '*' || parseInt(parts.dayOfWeek) === dow;
                
                let dateMatch = (parts.dayOfMonth !== '*' && parts.dayOfWeek !== '*') ? (dayOfMonthMatch || dayOfWeekMatch) : (dayOfMonthMatch && dayOfWeekMatch);
                if (minuteMatch && hourMatch && monthMatch && dateMatch) runs.push(new Date(currentDate));
            }
            return runs;
        }

        // --- UPDATE UI ---
        function updateUI() {
            const timeExpression = expressionInputEl.value.trim();
            const command = commandInputEl.value.trim();
            cronOutputEl.value = `${timeExpression} ${command}`;
            
            try {
                const parts = parseCron(timeExpression);
                const explanation = generateExplanation(parts);
                const nextRuns = calculateNextRuns(parts);
                
                cronExplanationEl.textContent = explanation;
                // Menggunakan styling inline variable agar dinamis
                cronExplanationEl.style.color = 'var(--ok)';
                resultsWrapper.style.borderColor = 'var(--ok)';
                
                let nextRunsHtml = '';
                nextRuns.forEach((run, index) => {
                    const formattedDate = run.toLocaleString('id-ID');
                    const prefix = index === 0 ? 'Berikutnya:' : 'Lalu:';
                    nextRunsHtml += `<div>${prefix} <span class="fw-bold">${formattedDate}</span></div>`;
                });
                nextRunsEl.innerHTML = nextRunsHtml;

            } catch (err) {
                cronExplanationEl.textContent = err.message;
                cronExplanationEl.style.color = 'var(--err)';
                resultsWrapper.style.borderColor = 'var(--err)';
                nextRunsEl.innerHTML = '';
            }
        }

        // --- Event Listeners ---
        function generateRandomCron() {
            const rand = (max) => Math.floor(Math.random() * max);
            expressionInputEl.value = `${rand(60)} ${rand(24)} * * *`;
            updateUI();
        }
        
        expressionInputEl.addEventListener("input", updateUI);
        commandInputEl.addEventListener("input", updateUI);
        randomBtn.addEventListener("click", generateRandomCron);
        
        copyBtn.addEventListener("click", () => {
            navigator.clipboard.writeText(cronOutputEl.value).then(() => {
                const originalIcon = copyBtn.innerHTML;
                copyBtn.innerHTML = `<i class="bi bi-check-lg text-success"></i>`;
                setTimeout(() => { copyBtn.innerHTML = originalIcon; }, 2000);
            });
        });

        // Init
        updateUI();
    });
</script>
{% endblock %}